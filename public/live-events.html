<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UNHINGED ‚Äî Live Events</title>
  <meta name="theme-color" content="#E11D2A" />
  <link rel="icon" href="/favicon.ico" />
  <style>
    :root{ --red:#E11D2A; --panel:#171923; --muted:#b8b9c6; --radius:16px; }
    *{box-sizing:border-box}
    html,body{margin:0;background:#0f0f12;color:#fff;font:500 16px/1.5 Inter,system-ui,Segoe UI,Roboto,Arial}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1280px;margin:0 auto;padding:16px}
    header{border-bottom:1px solid rgba(255,255,255,.06)}
    .bar{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .logo{display:flex;align-items:center;gap:10px}
    .mark{width:28px;height:28px;background:var(--red);border-radius:8px}
    .word{font-weight:1000}
    nav{display:flex;gap:10px}
    .btn{display:inline-flex;align-items:center;border:1px solid rgba(255,255,255,.12);padding:10px 14px;border-radius:12px;font-weight:800;background:#3a3c49;color:#fff;cursor:pointer;transition:all 0.2s ease}
    .btn:hover{background:#4a4c59;border-color:rgba(255,255,255,.3)}
    .btn.primary{background:var(--red);border-color:var(--red);color:#fff}
    .btn.primary:hover{background:#c41a23;border-color:#c41a23}
    .btn.ghost{background:transparent;border-color:rgba(255,255,255,.3);color:#fff}
    .btn.ghost:hover{background:rgba(255,255,255,.1)}
    .card{background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);overflow:hidden}
    .card h2{margin:0;padding:14px 14px;border-bottom:1px solid rgba(255,255,255,.06);background:#12131a;position:relative}
    .card-body{padding:20px}
    .form-group{margin-bottom:20px}
    .form-group label{display:block;margin-bottom:8px;font-weight:600;color:#fff}
    .form-group input, .form-group textarea, .form-group select{width:100%;padding:12px;border-radius:10px;border:1px solid #2a2c3a;background:#12131a;color:#fff;font-size:16px}
    .form-group textarea{min-height:120px;resize:vertical}
    .form-group .help-text{font-size:14px;color:var(--muted);margin-top:5px}
    .success-message{background:#10b981;color:#fff;padding:12px;border-radius:8px;margin:15px 0;display:none}
    .error-message{background:#ef4444;color:#fff;padding:12px;border-radius:8px;margin:15px 0;display:none}
    .event-card{background:#12131a;border:1px solid #2a2c39;border-radius:12px;padding:20px;margin-bottom:15px}
    .event-title{font-size:18px;font-weight:bold;color:#fff;margin-bottom:8px}
    .event-meta{font-size:14px;color:var(--muted);margin-bottom:12px}
    .event-description{font-size:15px;line-height:1.5;margin-bottom:12px}
    .event-details{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;font-size:14px}
    .event-detail{display:flex;align-items:center;gap:6px;color:var(--muted)}
    .event-actions{margin-top:15px;display:flex;gap:8px}
  </style>
</head>
<body>
  <header>
    <div class="wrap bar">
      <div class="logo"><div class="mark"></div><div class="word">UNHINGED</div></div>
      <nav>
        <a class="btn" href="./app.html">App</a>
        <a class="btn" href="./profile.html">Profile</a>
        <a class="btn" href="./login.html">Log in</a>
        <a class="btn primary" href="./signup.html">Join</a>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <section class="card" style="max-width:600px;margin:0 auto;">
      <h2>üé¨ Live Events & Meetups</h2>
      <div class="card-body">

        <form id="liveEventForm">
          <div class="form-group">
            <label for="eventTitle">Event Title *</label>
            <input type="text" id="eventTitle" name="eventTitle" required maxlength="100" placeholder="Saturday Night Meetup">
            <div class="help-text">What's the event called?</div>
          </div>

          <div class="form-group">
            <label for="eventLocation">Location *</label>
            <input type="text" id="eventLocation" name="eventLocation" required placeholder="Downtown Coffee Shop, 123 Main St">
            <div class="help-text">Where should people meet up?</div>
          </div>

          <div class="form-group">
            <label for="eventDate">Date & Time *</label>
            <input type="datetime-local" id="eventDate" name="eventDate" required>
            <div class="help-text">When is the meetup happening?</div>
          </div>

          <div class="form-group">
            <label for="eventDescription">Description</label>
            <textarea id="eventDescription" name="eventDescription" placeholder="Come hang out and meet other community members..."></textarea>
            <div class="help-text">Tell people what to expect</div>
          </div>

          <div class="form-group">
            <label for="eventType">Event Type</label>
            <select id="eventType" name="eventType">
              <option value="meetup">In-Person Meetup</option>
              <option value="coffee">Coffee Chat</option>
              <option value="drinks">Drinks & Social</option>
              <option value="activity">Group Activity</option>
              <option value="other">Other</option>
            </select>
          </div>

          <div class="form-group">
            <label for="maxAttendees">Max Attendees</label>
            <input type="number" id="maxAttendees" name="maxAttendees" min="1" max="100" placeholder="10">
            <div class="help-text">Optional: Limit the number of people</div>
          </div>

          <div class="form-group">
            <label for="contactInfo">Contact Info</label>
            <input type="text" id="contactInfo" name="contactInfo" placeholder="Your phone number or social media">
            <div class="help-text">How should people reach you? (optional)</div>
          </div>

          <div class="success-message" id="successMessage">
            ‚úÖ Event created successfully! People can now see it and RSVP.
          </div>

          <div class="error-message" id="errorMessage">
            ‚ùå Error creating event. Please check your details and try again.
          </div>

          <div style="text-align:center;margin-top:30px;">
            <button type="button" class="btn ghost" onclick="window.location.href='./app.html'">Cancel</button>
            <button type="submit" class="btn primary" style="margin-left:10px;">üìÖ Create Event</button>
          </div>
        </form>

      </div>
    </section>

    <!-- Live Events Display Board -->
    <section class="card" style="max-width:800px;margin:40px auto 0;">
      <h2>üìÖ Upcoming Live Events</h2>
      <div class="card-body">
        <div id="eventsBoard" style="display:grid;gap:15px;">
          <!-- Events will be loaded here -->
          <div class="muted" style="text-align:center;padding:20px;">Loading events...</div>
        </div>
      </div>
    </section>
  </main>

  <!-- Firebase -->
  <script type="module">
    import { auth, db } from "./js/firebase.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { collection, addDoc, serverTimestamp, onSnapshot, query, orderBy, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    let me = null;

    // Form handling
    const liveEventForm = document.getElementById('liveEventForm');
    const successMessage = document.getElementById('successMessage');
    const errorMessage = document.getElementById('errorMessage');
    const eventsBoard = document.getElementById('eventsBoard');

    // Load and display events
    function loadEvents() {
      const eventsRef = collection(db, 'liveEvents');
      const eventsQuery = query(eventsRef, orderBy('createdAt', 'desc'));

      onSnapshot(eventsQuery, (snapshot) => {
        if (snapshot.empty) {
          eventsBoard.innerHTML = '<div class="muted" style="text-align:center;padding:40px;">No events yet. Be the first to create one!</div>';
          return;
        }

        eventsBoard.innerHTML = '';

        snapshot.forEach(doc => {
          const event = doc.data();
          renderEvent(event, doc.id);
        });
      }, (error) => {
        console.error('Error loading events:', error);
        eventsBoard.innerHTML = '<div style="color:#ff6b6b;text-align:center;padding:20px;">Failed to load events. Please refresh the page.</div>';
      });
    }

    function renderEvent(event, eventId) {
      const eventCard = document.createElement('div');
      eventCard.className = 'event-card';

      // Format date
      let dateStr = 'Date not set';
      if (event.date) {
        try {
          const date = new Date(event.date);
          dateStr = date.toLocaleDateString() + ' at ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        } catch (e) {
          console.log('Date formatting error:', e);
        }
      }

      // Format created time
      let createdStr = '';
      if (event.createdAt && event.createdAt.toDate) {
        const created = event.createdAt.toDate();
        createdStr = created.toLocaleDateString();
      }

      eventCard.innerHTML = `
        <div class="event-title">${escapeHtml(event.title || 'Untitled Event')}</div>
        <div class="event-meta">Posted ${createdStr} ‚Ä¢ ${escapeHtml(event.type || 'meetup')}</div>
        
        <div class="event-details">
          <div class="event-detail">
            <span>üìç</span>
            <span>${escapeHtml(event.location || 'Location not specified')}</span>
          </div>
          <div class="event-detail">
            <span>üïí</span>
            <span>${dateStr}</span>
          </div>
          ${event.maxAttendees ? `
          <div class="event-detail">
            <span>üë•</span>
            <span>Max ${event.maxAttendees} people</span>
          </div>
          ` : ''}
          ${event.contactInfo ? `
          <div class="event-detail">
            <span>üìû</span>
            <span>${escapeHtml(event.contactInfo)}</span>
          </div>
          ` : ''}
        </div>

        ${event.description ? `
        <div class="event-description">${escapeHtml(event.description)}</div>
        ` : ''}

        <div class="event-actions">
          <button class="btn primary" onclick="rsvpToEvent('${eventId}')">üëç RSVP</button>
          <button class="btn ghost" onclick="shareEvent('${eventId}')">üì§ Share</button>
        </div>
      `;

      eventsBoard.appendChild(eventCard);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // RSVP to event
    window.rsvpToEvent = function(eventId) {
      if (!me) {
        alert('Please log in to RSVP to events');
        return;
      }
      alert('RSVP feature coming soon! For now, use the contact info to reach the organizer.');
    };

    // Share event
    window.shareEvent = function(eventId) {
      const url = window.location.href;
      if (navigator.share) {
        navigator.share({
          title: 'UNHINGED Live Event',
          text: 'Check out this live event!',
          url: url
        });
      } else {
        navigator.clipboard.writeText(url).then(() => {
          alert('Event link copied to clipboard!');
        }).catch(() => {
          alert('Event URL: ' + url);
        });
      }
    };

    liveEventForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!me) {
        alert('Please log in to create events');
        window.location.href = './login.html';
        return;
      }

      const formData = new FormData(e.target);
      const eventData = {
        title: formData.get('eventTitle'),
        location: formData.get('eventLocation'),
        date: formData.get('eventDate'),
        description: formData.get('eventDescription'),
        type: formData.get('eventType'),
        maxAttendees: formData.get('maxAttendees') ? parseInt(formData.get('maxAttendees')) : null,
        contactInfo: formData.get('contactInfo'),
        createdBy: me.uid,
        createdAt: serverTimestamp(),
        attendees: []
      };

      try {
        // Save event to database
        await addDoc(collection(db, 'liveEvents'), eventData);

        // Show success
        successMessage.style.display = 'block';
        errorMessage.style.display = 'none';

        // Reset form
        liveEventForm.reset();

        setTimeout(() => {
          successMessage.style.display = 'none';
        }, 5000);

      } catch (error) {
        console.error('Error creating event:', error);
        errorMessage.textContent = '‚ùå Error creating event: ' + error.message;
        errorMessage.style.display = 'block';
        successMessage.style.display = 'none';
      }
    });

    // Auth state
    onAuthStateChanged(auth, (user) => {
      me = user;
      if (!user) {
        alert('Please log in to create events');
        window.location.href = './login.html';
      } else {
        // Load events once user is authenticated
        loadEvents();
      }
    });

    // Load events immediately (will show all events, authentication not required for viewing)
    loadEvents();
  </script>
</body>
</html>