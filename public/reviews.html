<!DOCTYPE html><html lang="en">
<head>
<script type="module">
  import { initProfileGate } from "./js/profile_lock.js";
  initProfileGate();
</script></head>
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>UNHINGED ‚Äî Reviews</title>
<link rel="icon" href="data:,">
<style>
  :root{--red:#E11D2A}
  *{box-sizing:border-box} body{margin:0;background:#0f0f12;color:#fff;font:500 16px/1.5 Inter,system-ui}
  a{color:#fff;text-decoration:none}
  .wrap{max-width:1100px;margin:0 auto;padding:18px}
  .top{display:flex;gap:10px;align-items:center;margin-bottom:12px}
  .pill{padding:8px 12px;background:#1a1b22;border:1px solid rgba(255,255,255,.08);border-radius:999px}
  h1{margin:6px 0 2px;font-size:26px;font-weight:900}
  .sub{color:#cfd0de}

  .grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:14px}
  @media (min-width:900px){.grid{grid-template-columns:1fr 1fr}}
  .rev{background:#15161b;border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:12px}
  .rhead{display:flex;justify-content:space-between;align-items:center}
  .tags{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
  .tag{font-size:12px;padding:4px 8px;border-radius:999px;background:#23242e;border:1px solid rgba(255,255,255,.08)}
  .flames{color:#ff5b40;font-weight:900}

  .card{background:#14161a;border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:14px;margin-top:14px}
  label{display:block;margin:8px 0 4px;color:#d8d8e0}
  input,textarea,select{width:100%;background:#0c0c0c;border:1px solid #2a2a2a;color:#fff;padding:12px;border-radius:12px;outline:none}
  textarea{min-height:100px;resize:vertical}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .btn{appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:800;cursor:pointer}
  .btn.primary{background:var(--red);color:#fff}
  .msg{font-size:13px;color:#bdbdcc;margin-top:6px}
</style></head><body>
<div class="wrap">
  <div class="top">
    <a class="pill" href="index.html">‚Üê Home</a>
    <a class="pill" href="chaos.html">üî• Chaos Wall</a>
    <a class="pill" href="badges.html">üèÖ Badges</a>
    <a class="pill" href="redflags.html">üö© Red Flags</a>
  </div>

  <h1>Reviews</h1>
  <div class="sub">Honest, helpful feedback from past dates. Keep it factual, not spiteful.</div>

  <!-- live reviews -->
  <div id="list" class="grid">
    <div style="text-align:center;padding:40px;color:#666;grid-column:1/-1">Loading reviews...</div>
  </div>

  <!-- add a review -->
  <div class="card">
    <h3 style="margin:0 0 8px">Leave a Review</h3>
    <form id="revForm">
      <div class="row">
        <div style="flex:1 1 220px">
          <label>About (their username/handle)</label>
          <input id="reviewAbout" required placeholder="@TheirUsername">
        </div>
        <div style="flex:1 1 120px">
          <label>Rating (1‚Äì5 stars)</label>
          <select id="reviewRating">
            <option value="1">‚òÖ‚òÜ‚òÜ‚òÜ‚òÜ</option>
            <option value="2">‚òÖ‚òÖ‚òÜ‚òÜ‚òÜ</option>
            <option value="3" selected>‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ</option>
            <option value="4">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ</option>
            <option value="5">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</option>
          </select>
        </div>
      </div>
      <label>Review</label>
      <textarea id="reviewText" required placeholder="Be honest but fair. Focus on behaviors, not personal attacks." maxlength="500"></textarea>
      <button class="btn primary" type="submit">Submit Review</button>
      <div id="rmsg" class="msg">Reviews are posted immediately to help the community.</div>
    </form>
  </div>
</div>
<script type="module">
import { auth, db } from "./js/firebase.js";
import { collection, addDoc, onSnapshot, query, orderBy, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

let currentUser = null;

// Auth state observer
onAuthStateChanged(auth, (user) => {
  currentUser = user;
});

// Load and display reviews
function loadReviews() {
  const reviewsQuery = query(
    collection(db, "reviews"),
    orderBy("timestamp", "desc"),
    limit(50)
  );

  onSnapshot(reviewsQuery, (snapshot) => {
    const reviewsList = document.getElementById("list");
    
    if (snapshot.empty) {
      reviewsList.innerHTML = '<div style="text-align:center;padding:40px;color:#666;grid-column:1/-1">No reviews yet. Be the first to share!</div>';
      return;
    }
    
    const reviews = [];
    snapshot.forEach(doc => {
      reviews.push({ id: doc.id, ...doc.data() });
    });
    
    reviewsList.innerHTML = reviews.map(review => {
      const stars = '‚òÖ'.repeat(review.rating || 3) + '‚òÜ'.repeat(5 - (review.rating || 3));
      const reviewerName = review.reviewerName || 'Anonymous';
      
      return `
        <div class="rev">
          <div class="rhead">
            <strong>About: ${escapeHtml(review.subjectHandle || 'Unknown')}</strong>
            <span class="flames">${stars}</span>
          </div>
          <p style="margin:8px 0;color:#d9d9e3">"${escapeHtml(review.review)}"</p>
          <div style="text-align:right;font-size:12px;color:#888;margin-top:8px">
            ‚Äì ${escapeHtml(reviewerName)}
          </div>
        </div>
      `;
    }).join('');
  }, (error) => {
    console.error('Error loading reviews:', error);
    document.getElementById("list").innerHTML = '<div style="text-align:center;padding:40px;color:#666;grid-column:1/-1">Error loading reviews. Please try again.</div>';
  });
}

// Submit review
document.getElementById('revForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  if (!currentUser) {
    alert('Please log in to leave a review');
    return;
  }
  
  const subjectHandle = document.getElementById('reviewAbout').value.trim();
  const rating = parseInt(document.getElementById('reviewRating').value);
  const reviewText = document.getElementById('reviewText').value.trim();
  
  if (!subjectHandle || !reviewText) return;
  
  const msg = document.getElementById('rmsg');
  msg.textContent = 'Submitting review...';
  
  try {
    const reviewData = {
      subjectHandle: subjectHandle,
      reviewerName: currentUser.displayName || currentUser.email?.split('@')[0] || 'Anonymous',
      reviewerUserId: currentUser.uid,
      rating: rating,
      review: reviewText,
      timestamp: serverTimestamp(),
      verified: false
    };
    
    await addDoc(collection(db, "reviews"), reviewData);
    
    // Reset form
    document.getElementById('reviewAbout').value = '';
    document.getElementById('reviewText').value = '';
    document.getElementById('reviewRating').value = '3';
    msg.textContent = 'Review submitted successfully!';
    
    setTimeout(() => {
      msg.textContent = 'Reviews are posted immediately to help the community.';
    }, 3000);
    
  } catch (error) {
    console.error('Error submitting review:', error);
    msg.textContent = 'Error submitting review. Please try again.';
  }
});

// Utility function
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Initialize
loadReviews();
</script>
</body></html>