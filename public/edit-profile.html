<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Profile - Unhinged</title>
    <link rel="stylesheet" href="/style.css">
    <style>
        body {
            background: var(--bg, #0e0e12);
            color: #fff;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            min-height: 100vh;
            padding: 20px;
        }
        
        .edit-container {
            max-width: 600px;
            margin: 0 auto;
            background: var(--panel, #15161b);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--muted, #cfd0de);
            font-weight: 600;
        }
        
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            background: var(--bg, #0e0e12);
            border: 1px solid #444;
            border-radius: 8px;
            color: #fff;
            font-size: 16px;
        }
        
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--red, #E11D2A);
        }
        
        .btn {
            border: none;
            background: var(--red, #E11D2A);
            color: #fff;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin-right: 10px;
            transition: background 0.2s;
        }
        
        .btn:hover {
            background: #c41e2a;
        }
        
        .btn.secondary {
            background: #3a3a3a;
        }
        
        .btn.secondary:hover {
            background: #4a4a4a;
        }
        
        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .thumb {
            cursor: pointer;
            border: 2px solid transparent;
            border-radius: 8px;
            overflow: hidden;
            aspect-ratio: 1;
        }
        
        .thumb:hover {
            border-color: var(--red, #E11D2A);
        }
        
        .thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .required {
            color: var(--red, #E11D2A);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #fff;
        }
        
        .buttons {
            text-align: center;
            margin-top: 30px;
        }
    </style>
</head>
<body>
    <div class="edit-container">
        <h1>Complete Your Profile</h1>
        
        <div class="form-group">
            <label for="displayName">Display Name <span class="required">*</span></label>
            <input type="text" id="displayName" placeholder="Enter your display name">
        </div>
        
        <div class="form-group">
            <label for="age">Age <span class="required">*</span></label>
            <input type="number" id="age" min="18" max="100" placeholder="Enter your age">
        </div>
        
        <div class="form-group">
            <label for="location">State <span class="required">*</span></label>
            <input type="text" id="location" placeholder="Enter your state (e.g. California)">
        </div>
        
        <div class="form-group">
            <label for="username">Username (Optional)</label>
            <input type="text" id="username" placeholder="Enter a username">
        </div>
        
        <div class="form-group">
            <label for="hobbies">Hobbies (Optional)</label>
            <input type="text" id="hobbies" placeholder="What do you enjoy doing?">
        </div>
        
        <div class="form-group">
            <label for="interests">Interests (Optional)</label>
            <input type="text" id="interests" placeholder="What are you interested in?">
        </div>
        
        <div class="form-group">
            <label for="bio">Bio (Optional)</label>
            <textarea id="bio" rows="4" placeholder="Tell others about yourself..."></textarea>
        </div>
        
        <div class="form-group">
            <label for="avatar">Photos <span class="required">*</span></label>
            <input type="file" id="avatar" multiple accept="image/*">
            <div id="gallery" class="gallery"></div>
        </div>
        
        <div class="buttons">
            <button id="saveEdit" class="btn">Save Profile</button>
            <button id="logoutBtn" class="btn secondary">Logout</button>
        </div>
    </div>

    <script type="module">
        import {
            auth, db, storage, onAuthStateChanged,
            doc, getDoc, setDoc, serverTimestamp,
            sRef, uploadBytes, getDownloadURL, signOut
        } from "./js/firebase.js";

        // Helper: validate the profile object we're about to save
        function isComplete(data) {
            const hasName = !!(data?.displayName && String(data.displayName).trim());
            const ageNum = Number(data?.age);
            const hasAge = Number.isFinite(ageNum) && ageNum >= 18 && ageNum <= 100;
            const hasState = !!(data?.location && String(data.location).trim()); // STATE only
            const hasPhotos = Array.isArray(data?.photos) && data.photos.length > 0;
            return hasName && hasAge && hasState && hasPhotos;
        }

        // Wire Logout (if button present)
        document.getElementById("logoutBtn")?.addEventListener("click", async () => {
            try { await signOut(auth); } catch {}
            window.location.href = "/login.html";
        });

        // Save handler — uploads any new photos first, merges photos, sets flags, redirects when complete
        async function saveProfile() {
            const user = auth.currentUser;
            if (!user) return;

            // Gather inputs
            const displayName = document.getElementById("displayName")?.value?.trim() || "";
            const age = Number(document.getElementById("age")?.value || 0);
            const locationState = document.getElementById("location")?.value?.trim() || ""; // STATE only
            const username = document.getElementById("username")?.value?.trim() || null;
            const hobbies = document.getElementById("hobbies")?.value?.trim() || null;
            const interests = document.getElementById("interests")?.value?.trim() || null;
            const bio = document.getElementById("bio")?.value?.trim() || null;

            // Pre-validate basics
            if (!displayName || !Number.isFinite(age) || age < 18 || age > 100 || !locationState) {
                alert("⚠️ Please complete Display Name, Age (18–100), and State.");
                return;
            }

            // Load current doc for merging photos
            const currentSnap = await getDoc(doc(db, "users", user.uid));
            const currentData = currentSnap.exists() ? currentSnap.data() : {};
            const existingPhotos = Array.isArray(currentData.photos) ? currentData.photos.slice() : [];

            // Upload any new photos
            const fileInput = document.getElementById("avatar");
            const files = (fileInput && fileInput.files) ? Array.from(fileInput.files) : [];
            const newPhotoUrls = [];
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                // (best-judgment) client limit 10MB
                if (file.size > 10 * 1024 * 1024) {
                    alert(`Image "${file.name}" is over 10MB. Please choose a smaller file.`);
                    continue;
                }
                const filename = `${Date.now()}_${i}_${file.name.replace(/\s+/g, "_")}`;
                const ref = sRef(storage, `profilePhotos/${user.uid}/${filename}`);
                await uploadBytes(ref, file);
                const url = await getDownloadURL(ref);
                newPhotoUrls.push(url);
            }

            // Merge all photos; keep existing unless user deletes them elsewhere
            const allPhotos = existingPhotos.concat(newPhotoUrls);
            const primaryPhoto = currentData.primaryPhoto || allPhotos[0] || null;

            // Build update
            const payload = {
                uid: user.uid,
                displayName,
                username: username || null,
                age,
                location: locationState,       // store STATE here
                hobbies: hobbies || null,
                interests: interests || null,
                bio: bio || null,
                photos: allPhotos,
                hasPhotos: allPhotos.length > 0,
                primaryPhoto,
                updatedAt: serverTimestamp()
            };

            // Save
            await setDoc(doc(db, "users", user.uid), payload, { merge: true });

            // Re-check completeness
            const afterSnap = await getDoc(doc(db, "users", user.uid));
            const afterData = afterSnap.exists() ? afterSnap.data() : {};
            if (!isComplete(afterData)) {
                alert("⚠️ Please ensure you have a Display Name, valid Age (18–100), State, and at least one photo.");
                return;
            }

            // If complete: redirect to profile page (public view for themselves)
            window.location.href = "/profile.html";
        }

        // Bind Save
        document.getElementById("saveEdit")?.addEventListener("click", saveProfile);

        // Optional: make clicking a saved thumb set primary instantly (if your gallery uses #gallery)
        document.getElementById("gallery")?.addEventListener("click", async (e) => {
            const user = auth.currentUser;
            if (!user) return;
            const thumb = e.target.closest(".thumb");
            if (!thumb) return;
            const img = thumb.querySelector("img");
            if (!img?.src) return;
            await setDoc(doc(db, "users", user.uid), { primaryPhoto: img.src }, { merge: true });
        });

        // Ensure we're authenticated before enabling UI (optional)
        onAuthStateChanged(auth, (u) => {
            if (!u) window.location.href = "/login.html";
        });
    </script>
</body>
</html>
