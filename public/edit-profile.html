<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Profile - Unhinged</title>
  <link rel="stylesheet" href="/style.css">
  <style>
    body { background:#0e0e12; color:#fff; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; padding:20px; }
    .edit-container { max-width:600px; margin:0 auto; background:#15161b; padding:30px; border-radius:12px; }
    h1 { text-align:center; margin-bottom:30px; }
    .form-group { margin-bottom:20px; }
    .form-group label { display:block; margin-bottom:8px; color:#cfd0de; font-weight:600; }
    .form-group input, .form-group textarea {
      width:100%; padding:12px; background:#0e0e12; border:1px solid #444; border-radius:8px; color:#fff; font-size:16px;
    }
    .btn { border:none; background:#E11D2A; color:#fff; padding:12px 24px; border-radius:8px; cursor:pointer; font-weight:600; margin:5px 0; }
    .btn.secondary { background:#3a3a3a; }
    .gallery { display:grid; grid-template-columns:repeat(auto-fit,minmax(100px,1fr)); gap:10px; margin-top:10px; }
    .thumb { border-radius:8px; overflow:hidden; }
    .thumb img { width:100%; height:100px; object-fit:cover; display:block; }
    .status { margin-top:8px; font-size:.9rem; }
    .ok{color:#9ae6b4}.err{color:#ff8e8e}.prog{color:#ffd27f}
  </style>
</head>
<body>
  <div class="edit-container">
    <h1>Complete Your Profile</h1>

    <div class="form-group">
      <label for="displayName">Display Name *</label>
      <input id="displayName" type="text" placeholder="Enter your name">
    </div>

    <div class="form-group">
      <label for="age">Age *</label>
      <input id="age" type="number" min="18" max="100">
    </div>

    <div class="form-group">
      <label for="location">State *</label>
      <input id="location" type="text" placeholder="Your state (e.g. California)">
    </div>

    <div class="form-group">
      <label for="bio">Bio (optional)</label>
      <textarea id="bio" rows="3"></textarea>
    </div>

    <div class="form-group">
      <label for="avatar">Photos *</label>
      <input id="avatar" type="file" multiple accept="image/*">
      <button id="uploadBtn" class="btn secondary" type="button">Upload Selected Photos</button>
      <div id="uploadStatus" class="status"></div>
      <div id="gallery" class="gallery"></div>
    </div>

    <div class="buttons">
      <button id="saveEdit" class="btn">Save Profile</button>
      <button id="logoutBtn" class="btn secondary">Logout</button>
    </div>
  </div>

  <script type="module">
    import {
      auth, db, storage, onAuthStateChanged,
      doc, getDoc, setDoc, serverTimestamp,
      sRef, uploadBytes, getDownloadURL, signOut
    } from "./js/firebase.js";

    const gallery=document.getElementById("gallery");
    const statusBox=document.getElementById("uploadStatus");

    function isComplete(d){
      return d?.displayName && d.age>=18 && d.age<=100 && d.location && Array.isArray(d.photos) && d.photos.length>0;
    }

    async function loadPhotos(user){
      gallery.innerHTML="";
      const snap=await getDoc(doc(db,"users",user.uid));
      if(snap.exists() && Array.isArray(snap.data().photos)){
        snap.data().photos.forEach(url=>{
          const t=document.createElement("div");
          t.className="thumb";
          t.innerHTML=`<img src="${url}">`;
          gallery.appendChild(t);
        });
      }
    }

    // Upload photos
    document.getElementById("uploadBtn").addEventListener("click",async()=>{
      const user=auth.currentUser; if(!user) return;
      const files=Array.from(document.getElementById("avatar").files||[]);
      if(!files.length){statusBox.innerHTML="<span class='err'>Select photos first.</span>";return;}
      const urls=[];
      for(const f of files){
        if(f.size>10*1024*1024){alert(`⚠️ ${f.name} is too large (max 10MB)`);continue;}
        const name=`${Date.now()}_${f.name.replace(/\s+/g,"_")}`;
        const ref=sRef(storage,`images/${user.uid}/${name}`);
        await uploadBytes(ref,f);
        urls.push(await getDownloadURL(ref));
      }
      if(urls.length){
        const snap=await getDoc(doc(db,"users",user.uid));
        const data=snap.exists()?snap.data():{};
        const all=[...(data.photos||[]),...urls];
        await setDoc(doc(db,"users",user.uid),{photos:all,hasPhotos:true,primaryPhoto:data.primaryPhoto||all[0],updatedAt:serverTimestamp()},{merge:true});
        statusBox.innerHTML="<span class='ok'>✅ Uploaded successfully</span>";
        loadPhotos(user);
      }
    });

    // Save profile
    document.getElementById("saveEdit").addEventListener("click",async()=>{
      const user=auth.currentUser; if(!user)return;
      const data={
        displayName:document.getElementById("displayName").value.trim(),
        age:Number(document.getElementById("age").value),
        location:document.getElementById("location").value.trim(),
        bio:document.getElementById("bio").value.trim()||null,
        updatedAt:serverTimestamp()
      };
      const snap=await getDoc(doc(db,"users",user.uid));
      const current=snap.exists()?snap.data():{};
      const payload={...current,...data};
      await setDoc(doc(db,"users",user.uid),payload,{merge:true});
      if(!isComplete(payload)){alert("⚠️ Fill all required fields + upload at least one photo.");return;}
      window.location.href="/profile.html";
    });

    // Logout
    document.getElementById("logoutBtn").addEventListener("click",async()=>{await signOut(auth);window.location.href="/login.html";});

    // Auth guard + auto-load
    onAuthStateChanged(auth,u=>{if(!u)window.location.href="/login.html";else loadPhotos(u);});
  </script>
</body>
</html>
