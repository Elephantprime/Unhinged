<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Profile - Unhinged</title>
  <link rel="stylesheet" href="/style.css">
  <style>
    body {
      background: var(--bg, #0e0e12);
      color: #fff;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      min-height: 100vh;
      padding: 20px;
    }
    .edit-container {
      max-width: 600px;
      margin: 0 auto;
      background: var(--panel, #15161b);
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }
    .form-group { margin-bottom: 20px; }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: var(--muted, #cfd0de);
      font-weight: 600;
    }
    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      background: var(--bg, #0e0e12);
      border: 1px solid #444;
      border-radius: 8px;
      color: #fff;
      font-size: 16px;
    }
    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--red, #E11D2A);
    }
    .btn {
      border: none;
      background: var(--red, #E11D2A);
      color: #fff;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      margin-right: 10px;
      transition: background 0.2s;
    }
    .btn:hover { background: #c41e2a; }
    .btn.secondary { background: #3a3a3a; }
    .btn.secondary:hover { background: #4a4a4a; }
    .gallery {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }
    .thumb {
      cursor: pointer;
      border: 2px solid transparent;
      border-radius: 8px;
      overflow: hidden;
      aspect-ratio: 1;
    }
    .thumb:hover { border-color: var(--red, #E11D2A); }
    .thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .required { color: var(--red, #E11D2A); }
    h1 { text-align: center; margin-bottom: 30px; color: #fff; }
    .buttons { text-align: center; margin-top: 30px; }
    .status { margin-top: 8px; font-size: 0.9rem; }
    .status .ok { color: #9ae6b4; }
    .status .err { color: #ff8e8e; }
  </style>
</head>
<body>
  <div class="edit-container">
    <h1>Complete Your Profile</h1>

    <div class="form-group">
      <label for="displayName">Display Name <span class="required">*</span></label>
      <input type="text" id="displayName" placeholder="Enter your display name">
    </div>

    <div class="form-group">
      <label for="age">Age <span class="required">*</span></label>
      <input type="number" id="age" min="18" max="100" placeholder="Enter your age">
    </div>

    <div class="form-group">
      <label for="location">State <span class="required">*</span></label>
      <input type="text" id="location" placeholder="Enter your state (e.g. California)">
    </div>

    <div class="form-group">
      <label for="username">Username (Optional)</label>
      <input type="text" id="username" placeholder="Enter a username">
    </div>

    <div class="form-group">
      <label for="hobbies">Hobbies (Optional)</label>
      <input type="text" id="hobbies" placeholder="What do you enjoy doing?">
    </div>

    <div class="form-group">
      <label for="interests">Interests (Optional)</label>
      <input type="text" id="interests" placeholder="What are you interested in?">
    </div>

    <div class="form-group">
      <label for="bio">Bio (Optional)</label>
      <textarea id="bio" rows="4" placeholder="Tell others about yourself..."></textarea>
    </div>

    <!-- Upload button -->
    <div class="form-group">
      <label for="avatar">Profile Photos <span class="required">*</span></label>
      <input type="file" id="avatar" multiple accept="image/*">
      <button id="uploadBtn" class="btn secondary" type="button">Upload Selected Photos</button>
      <div id="uploadStatus" class="status"></div>
      <div id="gallery" class="gallery"></div>
    </div>

    <div class="buttons">
      <button id="saveEdit" class="btn">Save Profile</button>
      <button id="logoutBtn" class="btn secondary">Logout</button>
    </div>
  </div>

  <script type="module">
    import {
      auth, db, storage, onAuthStateChanged,
      doc, getDoc, setDoc, serverTimestamp,
      sRef, uploadBytes, getDownloadURL, signOut
    } from "./js/firebase.js";

    function isComplete(data) {
      const hasName = !!(data?.displayName && String(data.displayName).trim());
      const ageNum = Number(data?.age);
      const hasAge = Number.isFinite(ageNum) && ageNum >= 18 && ageNum <= 100;
      const hasState = !!(data?.location && String(data.location).trim());
      const hasPhotos = Array.isArray(data?.photos) && data.photos.length > 0;
      return hasName && hasAge && hasState && hasPhotos;
    }

    document.getElementById("logoutBtn")?.addEventListener("click", async () => {
      try { await signOut(auth); } catch {}
      window.location.href = "/login.html";
    });

    // Upload button handler
    document.getElementById("uploadBtn")?.addEventListener("click", async () => {
      const statusBox = document.getElementById("uploadStatus");
      const user = auth.currentUser;
      if (!user) {
        statusBox.innerHTML = "<span class='err'>⚠️ Please log in first.</span>";
        return;
      }
      const files = Array.from(document.getElementById("avatar").files || []);
      if (!files.length) {
        statusBox.innerHTML = "<span class='err'>⚠️ Select at least one photo.</span>";
        return;
      }
      const urls = [];
      for (const f of files) {
        if (f.size > 10 * 1024 * 1024) {
          alert(`⚠️ ${f.name} is too large (max 10MB)`);
          continue;
        }
        const name = `${Date.now()}_${f.name.replace(/\s+/g, "_")}`;
        const ref = sRef(storage, `profilePhotos/${user.uid}/${name}`);
        try {
          await uploadBytes(ref, f);
          urls.push(await getDownloadURL(ref));
        } catch (err) {
          statusBox.innerHTML = `<span class='err'>❌ Upload failed: ${err.message}</span>`;
          return;
        }
      }
      if (urls.length) {
        const snap = await getDoc(doc(db, "users", user.uid));
        const data = snap.exists() ? snap.data() : {};
        const all = [...(data.photos || []), ...urls];
        await setDoc(doc(db, "users", user.uid), {
          photos: all,
          hasPhotos: true,
          primaryPhoto: data.primaryPhoto || all[0],
          updatedAt: serverTimestamp()
        }, { merge: true });
        statusBox.innerHTML = "<span class='ok'>✅ Uploaded successfully</span>";
        renderGallery(all);
      }
    });

    function renderGallery(urls) {
      const gallery = document.getElementById("gallery");
      if (!gallery) return;
      gallery.innerHTML = "";
      urls.forEach(url => {
        const div = document.createElement("div");
        div.className = "thumb";
        div.innerHTML = `<img src="${url}" alt="profile photo">`;
        gallery.appendChild(div);
      });
    }

    // Save Profile
    document.getElementById("saveEdit")?.addEventListener("click", async () => {
      const user = auth.currentUser;
      if (!user) return;
      const displayName = document.getElementById("displayName")?.value?.trim() || "";
      const age = Number(document.getElementById("age")?.value || 0);
      const locationState = document.getElementById("location")?.value?.trim() || "";
      const username = document.getElementById("username")?.value?.trim() || null;
      const hobbies = document.getElementById("hobbies")?.value?.trim() || null;
      const interests = document.getElementById("interests")?.value?.trim() || null;
      const bio = document.getElementById("bio")?.value?.trim() || null;
      const snap = await getDoc(doc(db, "users", user.uid));
      const currentData = snap.exists() ? snap.data() : {};
      const allPhotos = currentData.photos || [];
      const payload = {
        uid: user.uid,
        displayName,
        username,
        age,
        location: locationState,
        hobbies,
        interests,
        bio,
        photos: allPhotos,
        hasPhotos: allPhotos.length > 0,
        primaryPhoto: currentData.primaryPhoto || allPhotos[0] || null,
        updatedAt: serverTimestamp()
      };
      await setDoc(doc(db, "users", user.uid), payload, { merge: true });
      const afterSnap = await getDoc(doc(db, "users", user.uid));
      if (!isComplete(afterSnap.data())) {
        alert("⚠️ Please complete all required fields and upload at least one photo.");
        return;
      }
      window.location.href = "/profile.html";
    });

    onAuthStateChanged(auth, (u) => {
      if (!u) window.location.href = "/login.html";
    });
  </script>
</body>
</html>
